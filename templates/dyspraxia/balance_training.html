{% extends "base.html" %}

{% block title %}Balance Training - Dyspraxia Support{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">‚öñÔ∏è Advanced Balance Training with Pose Detection</h1>
        <p style="color: #64748b;">Practice balance exercises with real-time pose analysis and feedback</p>
    </div>
    
    <!-- Camera Setup -->
    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <button onclick="startCamera()" id="startCameraBtn" class="btn btn-success">
                <i class="fas fa-video"></i> Start Camera & Pose Detection
            </button>
            <button onclick="stopCamera()" id="stopCameraBtn" class="btn btn-danger" style="display: none;">
                <i class="fas fa-video-slash"></i> Stop Camera
            </button>
            <div id="cameraStatus" style="color: #64748b; font-weight: 500;">Camera not active</div>
            <div id="poseStatus" style="color: #64748b; font-weight: 500; margin-left: 1rem;">Pose detection: Off</div>
        </div>
    </div>
    
    <!-- Difficulty Selection -->
    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">Choose Difficulty Level</h4>
        <div class="grid grid-3" style="gap: 1rem;">
            <button onclick="setDifficulty('easy')" class="btn btn-success difficulty-btn" data-difficulty="easy">
                <i class="fas fa-smile"></i> Easy (10s)
            </button>
            <button onclick="setDifficulty('medium')" class="btn btn-warning difficulty-btn" data-difficulty="medium">
                <i class="fas fa-meh"></i> Medium (15s)
            </button>
            <button onclick="setDifficulty('hard')" class="btn btn-danger difficulty-btn" data-difficulty="hard">
                <i class="fas fa-frown"></i> Hard (20s)
            </button>
        </div>
    </div>
    
    <!-- Exercise Display -->
    <div class="card" id="exerciseCard" style="display: none;">
        <div class="card-header">
            <h3 class="card-title" id="exerciseTitle">Balance Exercise</h3>
            <div style="display: flex; gap: 1rem;">
                <button onclick="getNewExercise()" class="btn btn-success">New Exercise</button>
                <button onclick="calibratePose()" id="calibrateBtn" class="btn btn-primary">Calibrate Pose</button>
            </div>
        </div>
        
        <div class="grid grid-2">
            <!-- Camera Feed with Pose Overlay -->
            <div style="position: relative;">
                <video id="videoElement" width="100%" height="400" style="border-radius: 8px; background: #000;" autoplay muted></video>
                <canvas id="poseCanvas" width="640" height="480" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                <div id="noCameraBalance" style="display: flex; align-items: center; justify-content: center; height: 400px; background: #f8fafc; border-radius: 8px;">
                    <div style="text-align: center; color: #64748b;">
                        <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Start camera for pose detection</p>
                    </div>
                </div>
            </div>
            
            <!-- Exercise Instructions and Feedback -->
            <div>
                <div id="exerciseContent" style="padding: 2rem; background: #f8fafc; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                    <div id="exerciseInstructions">
                        <p style="color: #64748b;">Select difficulty and start camera to begin</p>
                    </div>
                </div>
                
                <!-- Real-time Feedback -->
                <div id="realTimeFeedback" style="padding: 1rem; background: #fee2e2; border-radius: 8px; margin-bottom: 1rem; display: none;">
                    <h5 style="color: #ef4444; margin-bottom: 0.5rem;">Live Feedback</h5>
                    <div id="stabilityMeter" style="margin-bottom: 1rem;">
                        <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div id="stabilityBar" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem;">
                            <span id="stabilityText">Stability: 0%</span>
                        </div>
                    </div>
                    <div id="feedbackText" style="color: #64748b; font-size: 0.9rem;"></div>
                </div>
                
                <!-- Pose Detection Info -->
                <div id="poseInfo" style="padding: 1rem; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Pose Detected:</strong> <span id="poseDetected">No</span>
                        </div>
                        <div>
                            <strong>Balance Score:</strong> <span id="balanceScore">0</span>
                        </div>
                        <div>
                            <strong>Center of Mass:</strong> <span id="centerOfMass">-</span>
                        </div>
                        <div>
                            <strong>Sway Amount:</strong> <span id="swayAmount">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Timer and Controls -->
        <div style="padding: 1rem; text-align: center; background: #f8fafc; border-top: 1px solid #e2e8f0;">
            <div style="margin-bottom: 1rem;">
                <div id="timer" style="font-size: 3rem; font-weight: bold; color: #ef4444;">00:00</div>
                <div style="color: #64748b;">Time Remaining</div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button onclick="startExercise()" id="startBtn" class="btn btn-success">
                    <i class="fas fa-play"></i> Start Exercise
                </button>
                <button onclick="stopExercise()" id="stopBtn" class="btn btn-danger" style="display: none;">
                    <i class="fas fa-stop"></i> Stop Exercise
                </button>
                <button onclick="pauseExercise()" id="pauseBtn" class="btn btn-warning" style="display: none;">
                    <i class="fas fa-pause"></i> Pause
                </button>
            </div>
        </div>
        
        <!-- Results -->
        <div id="exerciseResults" style="display: none; padding: 1rem; background: #f0f9ff; border-top: 1px solid #e2e8f0;">
            <div id="resultsContent"></div>
        </div>
    </div>
</div>

<!-- MediaPipe and Pose Detection Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

<script>
let currentDifficulty = 'easy';
let currentExercise = null;
let exerciseTimer = null;
let timeRemaining = 0;
let exerciseStartTime = null;
let exerciseActive = false;
let exercisePaused = false;

// Camera and pose detection variables
let videoStream = null;
let videoElement = null;
let poseCanvas = null;
let poseCtx = null;
let pose = null;
let camera = null;

// Pose tracking variables
let poseDetected = false;
let stabilityHistory = [];
let currentStability = 0;
let baselinePose = null;
let poseCalibrated = false;

document.addEventListener('DOMContentLoaded', function() {
    videoElement = document.getElementById('videoElement');
    poseCanvas = document.getElementById('poseCanvas');
    poseCtx = poseCanvas.getContext('2d');
    
    initializePoseDetection();
});

function initializePoseDetection() {
    // Initialize MediaPipe Pose
    pose = new Pose({
        locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }
    });
    
    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        smoothSegmentation: false,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    
    pose.onResults(onPoseResults);
}

async function startCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: 'user'
            } 
        });
        
        videoElement.srcObject = videoStream;
        videoElement.style.display = 'block';
        document.getElementById('noCameraBalance').style.display = 'none';
        
        document.getElementById('startCameraBtn').style.display = 'none';
        document.getElementById('stopCameraBtn').style.display = 'inline-block';
        document.getElementById('cameraStatus').textContent = 'Camera active';
        document.getElementById('poseStatus').textContent = 'Pose detection: Starting...';
        
        // Start pose detection
        camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
        
        document.getElementById('poseStatus').textContent = 'Pose detection: Active';
        showNotification('Camera and pose detection started!', 'success');
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        showNotification('Could not access camera. Please check permissions.', 'error');
        document.getElementById('cameraStatus').textContent = 'Camera access denied';
    }
}

function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    
    if (camera) {
        camera.stop();
        camera = null;
    }
    
    videoElement.style.display = 'none';
    document.getElementById('noCameraBalance').style.display = 'flex';
    
    document.getElementById('startCameraBtn').style.display = 'inline-block';
    document.getElementById('stopCameraBtn').style.display = 'none';
    document.getElementById('cameraStatus').textContent = 'Camera stopped';
    document.getElementById('poseStatus').textContent = 'Pose detection: Off';
    
    stopExercise();
    clearPoseCanvas();
}

function onPoseResults(results) {
    // Clear canvas
    poseCtx.clearRect(0, 0, poseCanvas.width, poseCanvas.height);
    
    if (results.poseLandmarks) {
        poseDetected = true;
        document.getElementById('poseDetected').textContent = 'Yes';
        
        // Draw pose landmarks
        drawPoseLandmarks(results.poseLandmarks);
        
        // Analyze pose stability
        if (exerciseActive && !exercisePaused) {
            analyzePoseStability(results.poseLandmarks);
        }
        
        // Update pose info
        updatePoseInfo(results.poseLandmarks);
        
    } else {
        poseDetected = false;
        document.getElementById('poseDetected').textContent = 'No';
        currentStability = 0;
        updateStabilityDisplay();
    }
}

function drawPoseLandmarks(landmarks) {
    // Draw pose connections
    const connections = [
        [11, 12], [11, 13], [13,
    // Draw pose connections
    const connections = [
        [11, 12], [11, 13], [13, 15], [12, 14], [14, 16], // shoulders and arms
        [11, 23], [12, 24], [23, 24], // torso
        [23, 25], [25, 27], [27, 29], [29, 31], // left leg
        [24, 26], [26, 28], [28, 30], [30, 32], // right leg
        [15, 17], [15, 19], [15, 21], [17, 19], // left hand
        [16, 18], [16, 20], [16, 22], [18, 20]  // right hand
    ];
    
    // Draw connections
    poseCtx.strokeStyle = '#00ff00';
    poseCtx.lineWidth = 2;
    
    connections.forEach(([start, end]) => {
        const startPoint = landmarks[start];
        const endPoint = landmarks[end];
        
        if (startPoint && endPoint) {
            poseCtx.beginPath();
            poseCtx.moveTo(startPoint.x * poseCanvas.width, startPoint.y * poseCanvas.height);
            poseCtx.lineTo(endPoint.x * poseCanvas.width, endPoint.y * poseCanvas.height);
            poseCtx.stroke();
        }
    });
    
    // Draw key landmarks
    poseCtx.fillStyle = '#ff0000';
    const keyPoints = [11, 12, 23, 24, 25, 26]; // shoulders, hips
    
    keyPoints.forEach(pointIndex => {
        const point = landmarks[pointIndex];
        if (point) {
            poseCtx.beginPath();
            poseCtx.arc(
                point.x * poseCanvas.width, 
                point.y * poseCanvas.height, 
                5, 0, 2 * Math.PI
            );
            poseCtx.fill();
        }
    });
    
    // Draw center of mass indicator
    const centerOfMass = calculateCenterOfMass(landmarks);
    if (centerOfMass) {
        poseCtx.fillStyle = '#0000ff';
        poseCtx.beginPath();
        poseCtx.arc(
            centerOfMass.x * poseCanvas.width,
            centerOfMass.y * poseCanvas.height,
            8, 0, 2 * Math.PI
        );
        poseCtx.fill();
        
        // Draw stability zone
        poseCtx.strokeStyle = '#0000ff';
        poseCtx.lineWidth = 1;
        poseCtx.setLineDash([5, 5]);
        poseCtx.beginPath();
        poseCtx.arc(
            centerOfMass.x * poseCanvas.width,
            centerOfMass.y * poseCanvas.height,
            30, 0, 2 * Math.PI
        );
        poseCtx.stroke();
        poseCtx.setLineDash([]);
    }
}

function calculateCenterOfMass(landmarks) {
    // Calculate center of mass using hip landmarks
    const leftHip = landmarks[23];
    const rightHip = landmarks[24];
    
    if (leftHip && rightHip) {
        return {
            x: (leftHip.x + rightHip.x) / 2,
            y: (leftHip.y + rightHip.y) / 2
        };
    }
    return null;
}

function analyzePoseStability(landmarks) {
    const centerOfMass = calculateCenterOfMass(landmarks);
    
    if (!centerOfMass) {
        currentStability = 0;
        updateStabilityDisplay();
        return;
    }
    
    // If we have a baseline pose, compare against it
    if (poseCalibrated && baselinePose) {
        const deviation = Math.sqrt(
            Math.pow(centerOfMass.x - baselinePose.x, 2) + 
            Math.pow(centerOfMass.y - baselinePose.y, 2)
        );
        
        // Convert deviation to stability score (0-100)
        currentStability = Math.max(0, 100 - (deviation * 1000));
    } else {
        // Without baseline, use movement analysis
        stabilityHistory.push(centerOfMass);
        
        if (stabilityHistory.length > 10) {
            stabilityHistory.shift();
        }
        
        if (stabilityHistory.length >= 5) {
            const avgX = stabilityHistory.reduce((sum, pos) => sum + pos.x, 0) / stabilityHistory.length;
            const avgY = stabilityHistory.reduce((sum, pos) => sum + pos.y, 0) / stabilityHistory.length;
            
            const variance = stabilityHistory.reduce((sum, pos) => {
                return sum + Math.pow(pos.x - avgX, 2) + Math.pow(pos.y - avgY, 2);
            }, 0) / stabilityHistory.length;
            
            currentStability = Math.max(0, 100 - (variance * 10000));
        }
    }
    
    updateStabilityDisplay();
    updateRealTimeFeedback();
}

function updateStabilityDisplay() {
    const stabilityBar = document.getElementById('stabilityBar');
    const stabilityText = document.getElementById('stabilityText');
    
    stabilityBar.style.width = currentStability + '%';
    stabilityText.textContent = `Stability: ${Math.round(currentStability)}%`;
    
    // Update color based on stability
    if (currentStability >= 80) {
        stabilityBar.style.background = '#10b981';
    } else if (currentStability >= 60) {
        stabilityBar.style.background = '#f59e0b';
    } else {
        stabilityBar.style.background = '#ef4444';
    }
    
    document.getElementById('balanceScore').textContent = Math.round(currentStability);
}

function updateRealTimeFeedback() {
    const feedbackText = document.getElementById('feedbackText');
    
    if (currentStability >= 85) {
        feedbackText.textContent = 'üéâ Excellent balance! You\'re very stable.';
        feedbackText.style.color = '#10b981';
    } else if (currentStability >= 70) {
        feedbackText.textContent = 'üëç Good balance! Try to stay steady.';
        feedbackText.style.color = '#f59e0b';
    } else if (currentStability >= 50) {
        feedbackText.textContent = '‚ö†Ô∏è Focus on your balance. Use your arms for stability.';
        feedbackText.style.color = '#f59e0b';
    } else {
        feedbackText.textContent = '‚ùå Work on maintaining your balance. Keep practicing!';
        feedbackText.style.color = '#ef4444';
    }
}

function updatePoseInfo(landmarks) {
    const centerOfMass = calculateCenterOfMass(landmarks);
    
    if (centerOfMass) {
        document.getElementById('centerOfMass').textContent = 
            `X: ${centerOfMass.x.toFixed(3)}, Y: ${centerOfMass.y.toFixed(3)}`;
        
        // Calculate sway amount
        if (stabilityHistory.length >= 2) {
            const lastPos = stabilityHistory[stabilityHistory.length - 1];
            const prevPos = stabilityHistory[stabilityHistory.length - 2];
            const sway = Math.sqrt(
                Math.pow(lastPos.x - prevPos.x, 2) + 
                Math.pow(lastPos.y - prevPos.y, 2)
            );
            document.getElementById('swayAmount').textContent = (sway * 1000).toFixed(2) + ' units';
        }
    }
}

function calibratePose() {
    if (!poseDetected) {
        showNotification('Please stand in view of the camera first', 'warning');
        return;
    }
    
    // Get current pose as baseline
    const centerOfMass = calculateCenterOfMass(pose.poseLandmarks || []);
    
    if (centerOfMass) {
        baselinePose = centerOfMass;
        poseCalibrated = true;
        document.getElementById('calibrateBtn').textContent = 'Recalibrate';
        document.getElementById('calibrateBtn').classList.remove('btn-primary');
        document.getElementById('calibrateBtn').classList.add('btn-success');
        showNotification('Pose calibrated! This is your baseline position.', 'success');
    } else {
        showNotification('Could not detect pose for calibration', 'error');
    }
}

function clearPoseCanvas() {
    if (poseCtx) {
        poseCtx.clearRect(0, 0, poseCanvas.width, poseCanvas.height);
    }
}

function setDifficulty(difficulty) {
    currentDifficulty = difficulty;
    
    // Update button styles
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
        btn.classList.add('btn-primary');
    });
    
    const selectedBtn = document.querySelector(`[data-difficulty="${difficulty}"]`);
    selectedBtn.classList.remove('btn-primary');
    if (difficulty === 'easy') selectedBtn.classList.add('btn-success');
    else if (difficulty === 'medium') selectedBtn.classList.add('btn-warning');
    else selectedBtn.classList.add('btn-danger');
    
    getNewExercise();
}

async function getNewExercise() {
    try {
        const response = await fetch('/dyspraxia/get-balance-exercise', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                difficulty: currentDifficulty
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentExercise = result.exercise;
            displayExercise(result.exercise);
            document.getElementById('exerciseCard').style.display = 'block';
            resetTimer();
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error getting exercise', 'error');
    }
}

function displayExercise(exercise) {
    document.getElementById('exerciseTitle').textContent = exercise.name;
    
    const content = document.getElementById('exerciseInstructions');
    content.innerHTML = `
        <div style="margin-bottom: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">‚öñÔ∏è</div>
            <h3 style="margin-bottom: 1rem; color: #ef4444;">${exercise.name}</h3>
            <p style="font-size: 1.2rem; color: #64748b; margin-bottom: 1rem;">${exercise.description}</p>
        </div>
        
        <div style="background: #fee2e2; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
            <h4 style="color: #ef4444; margin-bottom: 1rem;">Instructions:</h4>
            <p style="color: #64748b; font-size: 1.1rem; line-height: 1.6; margin-bottom: 1rem;">${exercise.instructions}</p>
            
            ${exercise.tips ? `
                <div style="margin-top: 1rem;">
                    <h5 style="color: #ef4444; margin-bottom: 0.5rem;">Tips:</h5>
                    <ul style="color: #64748b; margin: 0; padding-left: 1.5rem;">
                        ${exercise.tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${exercise.duration}s</div>
                <div style="color: #64748b;">Duration</div>
            </div>
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${exercise.difficulty}</div>
                <div style="color: #64748b;">Difficulty</div>
            </div>
        </div>
    `;
    
    timeRemaining = exercise.duration;
    updateTimerDisplay();
}

function startExercise() {
    if (!currentExercise) {
        showNotification('Please select an exercise first', 'warning');
        return;
    }
    
    if (!poseDetected) {
        showNotification('Please stand in view of the camera', 'warning');
        return;
    }
    
    exerciseStartTime = Date.now();
    timeRemaining = currentExercise.duration;
    exerciseActive = true;
    exercisePaused = false;
    
    // Reset stability tracking
    stabilityHistory = [];
    currentStability = 0;
    
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'inline-block';
    document.getElementById('pauseBtn').style.display = 'inline-block';
    document.getElementById('realTimeFeedback').style.display = 'block';
    
    exerciseTimer = setInterval(() => {
        if (!exercisePaused) {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                completeExercise();
            }
        }
    }, 1000);
    
    showNotification('Exercise started! Maintain your balance and follow the pose detection.', 'success');
}

function pauseExercise() {
    exercisePaused = !exercisePaused;
    const pauseBtn = document.getElementById('pauseBtn');
    
    if (exercisePaused) {
        pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
        pauseBtn.classList.remove('btn-warning');
        pauseBtn.classList.add('btn-success');
        showNotification('Exercise paused', 'warning');
    } else {
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        pauseBtn.classList.remove('btn-success');
        pauseBtn.classList.add('btn-warning');
        showNotification('Exercise resumed', 'success');
    }
}

function stopExercise() {
    if (exerciseTimer) {
        clearInterval(exerciseTimer);
        exerciseTimer = null;
    }
    
    exerciseActive = false;
    exercisePaused = false;
    
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('pauseBtn').style.display = 'none';
    document.getElementById('realTimeFeedback').style.display = 'none';
    
    resetTimer();
    showNotification('Exercise stopped', 'warning');
}

function completeExercise() {
    if (exerciseTimer) {
        clearInterval(exerciseTimer);
        exerciseTimer = null;
    }
    
    const completedTime = exerciseStartTime ? (Date.now() - exerciseStartTime) / 1000 : 0;
    const targetTime = currentExercise.duration;
    const completionRate = Math.min(100, (completedTime / targetTime) * 100);
    
    // Calculate average stability during exercise
    const avgStability = stabilityHistory.length > 0 ? 
        stabilityHistory.reduce((sum, pos, index) => {
            // Use the stability score from that moment (simplified)
            return sum + (index < stabilityHistory.length - 1 ? 
                Math.max(0, 100 - Math.sqrt(
                    Math.pow(pos.x - stabilityHistory[0].x, 2) + 
                    Math.pow(pos.y - stabilityHistory[0].y, 2)
                ) * 1000) : currentStability);
        }, 0) / stabilityHistory.length : currentStability;
    
    exerciseActive = false;
    exercisePaused = false;
    
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('pauseBtn').style.display = 'none';
    document.getElementById('realTimeFeedback').style.display = 'none';
    
    displayResults(completedTime, completionRate, avgStability);
    saveProgress(completedTime, avgStability);
    
    showNotification('Exercise completed! Great job!', 'success');
}

function displayResults(completedTime, completionRate, avgStability) {
    const results = document.getElementById('exerciseResults');
    const content = document.getElementById('resultsContent');
    
    let feedback = '';
    let emoji = '';
    let overallScore = (completionRate * 0.4) + (avgStability * 0.6);
    
    if (overallScore >= 85) {
        feedback = 'Outstanding! Your balance and stability are excellent.';
        emoji = 'üéâ';
    } else if (overallScore >= 70) {
        feedback = 'Great job! You maintained good balance throughout the exercise.';
        emoji = 'üëç';
    } else if (overallScore >= 50) {
        feedback = 'Good effort! Keep practicing to improve your balance.';
        emoji = 'üí™';
    } else {
        feedback = 'Keep working on it! Balance takes time to develop.';
        emoji = 'üåü';
    }
    
    content.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">${emoji}</div>
            <h4 style="margin-bottom: 1rem; color: #ef4444;">Exercise Complete!</h4>
            
            <div class="grid grid-4" style="gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${Math.round(completedTime)}s</div>
                    <div style="color: #64748b;">Duration</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">${Math.round(completionRate)}%</div>
                    <div style="color: #64748b;">Completion</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${Math.round(avgStability)}%</div>
                    <div style="color: #64748b;">Avg Stability</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${Math.round(overallScore)}</div>
                    <div style="color: #64748b;">Overall Score</div>
                </div>
            </div>
            
            <p style="color: #64748b; font-size: 1.1rem; margin-bottom: 2rem;">${feedback}</p>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button onclick="getNewExercise()" class="btn btn-primary">Try Another Exercise</button>
                <button onclick="startExercise()" class="btn btn-success">Repeat Exercise</button>
            </div>
        </div>
    `;
    
    results.style.display = 'block';
}

async function saveProgress(completedTime, avgStability) {
    try {
        await fetch('/dyspraxia/submit-balance-result', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exercise_name: currentExercise.name,
                duration: completedTime,
                stability: avgStability
            })
        });
    } catch (error) {
        console.error('Error saving progress:', error);
    }
}

function resetTimer() {
    if (exerciseTimer) {
        clearInterval(exerciseTimer);
        exerciseTimer = null;
    }
    
    if (currentExercise) {
        timeRemaining = currentExercise.duration;
        updateTimerDisplay();
    }
    
    document.getElementById('exerciseResults').style.display = 'none';
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('timer').textContent = display;
    
    // Change color based on time remaining
    const timer = document.getElementById('timer');
    if (timeRemaining <= 5) {
        timer.style.color = '#ef4444';
    } else if (timeRemaining <= 10) {
        timer.style.color = '#f59e0b';
    } else {
        timer.style.color = '#10b981';
    }
}

// Initialize with first exercise
document.addEventListener('DOMContentLoaded', function() {
    // Auto-start with easy difficulty
    setDifficulty('easy');
});
</script>
{% endblock %}
